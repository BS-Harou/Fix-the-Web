<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="../images/icon-18.png" />
    <title>Options | Fix the Web</title>

    <style type="text/css">
    @import '../styles/modal_styles.css';
    @import '../styles/options_styles.css';
    </style>
</head>
<body>
    <div id="nav"></div><!--This tab bar is automatically filled with JS.-->

    <!-- To create a new tab, simply create a new <section> element with an ID. The ID will be the title of the tab. -->
    <section id="preferences">
        <h1>Fix the Web <span class="light"> Options</span></h1>

        <form id="prefs-form">
                <div class="sub_section">
                    <label>Check for updates to the CSS patches file
                        <input type="range" min="0" max="960" step="60" name="update-interval" id="update-interval" />
                        <em><span id="update-interval-value"></span></em>
                    </label>

                    <div>
                        <div id="update">check for updates now</div>
                    </div>
                </div>

                <p class="sub_section">
                    Show reports count in the toolbar icon badge by
                    <input type="radio" id="display-reports-by-domain" name="display-reports-by" value="domain" />
                    <label for="display-reports-by-domain">
                        <strong>domain</strong>
                    </label>
                    <input type="radio" id="display-reports-by-page" name="display-reports-by" value="page" />
                    <label for="display-reports-by-page">
                        <strong>page</strong>
                    </label>
                </p>
                <div class="sub_section">
                    Make CSS3 properties coded for other browsers <strong><a href="https://addons.opera.com/addons/extensions/details/css-prefixr" title="Feature derived from Christoph142's CSS3 Prefixr extension">work in Opera too</a></strong>?
                    <input type="radio" name="prefixr" value="true" id="prefixr-on" />
                    <label for="prefixr-on">
                        <strong>Enable</strong>
                    </label>
                    <input type="radio" name="prefixr" value="false" id="prefixr-off" />
                    <label for="prefixr-off">
                        <strong>Disable</strong>
                    </label>

                    <div>
                        <label for="prefixr-exclude">Don't run Prefixr on these sites <em>(one site per line)</em>:</label>
                        <textarea name="prefixr-exclude" id="prefixr-exclude" cols="60" rows="7" title="one site per line; don't include the protocol (e.g. http://)" placeholder="exclude.com"></textarea>
                    </div>
                </div>
                <div class="sub_section">
                    Browser Identification (<abbr title="Will mask Javascript properties as the selected browser. However, the user-agent string sent in the HTTP request can not be masked by the extension. To do that, right-click the page, select Edit Site Preferences..., and go to Network &gt; Browser Identification">about</abbr>): 
                    
                    <input type="radio" name="browser-id" value="opera" id="as-opera" />
                    <label for="as-opera">
                        <strong>Opera (default)</strong>
                    </label>
                    
                    <input type="radio" name="browser-id" value="ie" id="as-ie" />
                    <label for="as-ie">
                        <strong>Internet Explorer</strong>
                    </label>
                    
                    <input type="radio" name="browser-id" value="firefox" id="as-firefox" />
                    <label for="as-firefox">
                        <strong>Firefox</strong>
                    </label>
                    
                    <input type="radio" name="browser-id" value="chrome" id="as-chrome" />
                    <label for="as-chrome">
                        <strong>Chrome</strong>
                    </label>
                </div>
        </form>
        <!--
    </section>
    <section id="authenticate">-->
<!--        <h1>Fix the Web <span class="light"> Authentication</span></h1>-->
        <form id="auth" class="hide sub_section">
            <p>
                <a href="#" id="twitter-login"></a>
<!--                <a href="#" id="facebook-login"></a>-->
            </p>

            <p>
                <input type="text" placeholder="PIN number" size="30" id="pin-number" required="required" />
                <button type="submit">Connect</button>
            </p>

            <button disabled="disabled">Connect with your Opera Account</button>
            <em>(Opera's API is not capable of doing this yet. In the meanwhile, login with Twitter.)</em>
        </form>

        <p id="loading"><img src="../images/loading-circle.png" alt="loading" title="Loading..." /></p>

        <p id="connected" class="hide">You are connected to your Twitter account right now. <strong><a href="#" id="disconnect">disconnect</a></strong></p>

        <ul id="recent-posts"></ul><!--populated by Javascript-->
    </section>
    <section id="about">
        <h1>Fix the Web <span class="light"> About</span></h1>

        <p>Fix the Web is open source. You can contribute to the project on Github:</p>

        <ul>
            <li><strong><a href="http://my.opera.com/fix-the-web">My Opera <em>Fix the Web</em> Group</a></strong> (support, blog, forums, etc.)</li>
            <li><strong><a href="http://www.operaturkiye.net/fix-the-web">Home Page</a></strong> (still under construction)</li>
            <li><strong><a href="http://github.com/cyberstream/Fix-the-Web">Main extension files repository</a></strong></li>
            <li><strong><a href="http://github.com/cyberstream/Fix-the-Web-Server-Side">Server-side repository</a></strong></li>
            <li><strong><a href="http://github.com/cyberstream/Fix-the-Web-CSS-Patches">CSS Patches</a></strong> (If a website just needs CSS to be patched, then add the patch to the <em><strong>patches.json</strong></em> file in this repo. If the problematic website needs JS for the patch, place it in <em><strong>includes/</strong>patches.js</em> in the <a title="Fix the Web's Repository" href="http://github.com/cyberstream/Fix-the-Web">extension repo</a>.)</li>
        </ul>
            
        <div id="columnize">            
            <div>
                <h4>Contributors:</h4>
            
                <ul>
                    <li><strong><a href="http://my.opera.com/cyberstream">cyberstream</a></strong> <a href="mailto:cyberstream@myopera.com">(email)</a></li>
                    <li><strong><a href="http://my.opera.com/greench">greench</a></strong> <a href="mailto:greench@myopera.com">(email)</a></li>
                    <li><strong><a href="http://my.opera.com/inbuster">inbuster</a></strong> <a href="mailto:inbuster@myopera.com">(email)</a></li>
                    <li><strong><a href="http://my.opera.com/metude">metude</a></strong> <a href="mailto:metude@myopera.com">(email)</a></li>
                    <li><strong><a href="http://my.opera.com/zahek">zahek</a></strong> <a href="mailto:zahek@myopera.com">(email)</a></li>
                    <li><strong><a href="http://my.opera.com/BS-Harou">BS-Harou</a></strong></li>
                </ul>
            </div>
            
            <div>
                <h4>Thanks:</h4>
                
                <ul>
                    <li><strong><a href="http://my.opera.com/AntonDiaz">AntonDiaz</a></strong> (Added CSS fixes from his <strong><a href="https://addons.opera.com/addons/extensions/details/twitter-fix">Twitter Fix</a></strong> extension)</li>
                    <li><strong><a href="http://my.opera.com/Christoph142">Christoph142</a></strong> (Based the <strong>-o- prefix</strong> feature off of his <strong><a href="https://addons.opera.com/addons/extensions/details/css-prefixr">CSS Prefixr</a></strong> extension)</li>
                    <li><strong><a href="http://my.opera.com/celeborn1">Yiğit Ateş</a></strong> (Added Turkish translation)</li>
                </ul>
            </div>
        </div>
    </section>

    <footer>
        <a href="index.html">Recent Reports List</a>
    </footer>

    <script type="text/javascript" src="scripts/background.js"></script>
    <script type="text/javascript" src="scripts/jsOAuth-1.3.3.min.js"></script>
    <script type="text/javascript" src="scripts/jquery-1.6.4.min.js"></script>
    <script type="text/javascript" src="scripts/jquery.simplemodal.1.4.2.min.js"></script>
    <script type="text/javascript">
        $.support.cors = true;

        // get recent blog posts from Fix the Web's blog
        $(function() {
            $.get('http://my.opera.com/fix-the-web/xml/rss/blog', function(data) {
                var items = $('item', data);

                // populate the list with the the 7 most recent blog posts
                for (i in items) {
                    if ( i > 7 ) break;
                    if ( !items[i] || typeof items[i].getElementsByTagName != 'function' || i == 'context' ) continue;

                    var link = items[i].getElementsByTagName('link')[0].firstChild.nodeValue,
                          title = items[i].getElementsByTagName('title')[0].firstChild.nodeValue,
                          time = items[i].getElementsByTagName('pubDate')[0].firstChild.nodeValue
                          
                    try {
                        time = new Date(time);
                        
                        switch( Math.floor ((new Date() - time) / (1000 * 60 * 60 * 24)) ) { // this is the number of days since the article was posted
                            case 0 :
                                time = 'posted today'
                                break;
                            case 1 :
                                time = 'posted yesterday'
                                break;
                            case 2 : 
                                time = 'posted two days ago'
                                break;
                            case 3 :
                                time = 'posted three days ago'
                                break;
                            case 4 :
                                time = 'posted four days ago'
                                break;
                            case 5 :
                                time = 'posted five days ago'
                                break;
                            case 6 : 
                                time = 'posted six days ago'
                                break;
                            case 7 :
                                time = 'posted a week ago'
                                break;
                            default:
                                time = 'posted on ' + time.toLocaleDateString();
                        }                         
                        
                    } catch (e) {
                        time = '';
                    }

                    $('<li><a href="' +link+ '" title="Click to read this post" target="_blank">' +title+ '</a> <strong class="light">' +time+ '</strong></li>').appendTo('#recent-posts');
                }

                if ($('#recent-posts').children().length) {
                    $('<h3 id="blog-header"><span class="light">Latest Posts on</span> <a href="http://my.opera.com/fix-the-web/blog">Fix the Web\'s Blog</a></h3>').insertBefore('#recent-posts')

                    var k = -1,
                          posts = $('#recent-posts').children();

                    function loop () {
                        var previous = k;

                        if (k + 1 == posts.length) k = 0;
                        else k++;

                        $(posts[previous]).removeClass('current');
                        $(posts[k]).addClass('current');

                        setTimeout(loop, 4000);
                    }

                    loop();
                }
            });
        });

    var form = document.getElementById("prefs-form"),
          fields = form.querySelectorAll("input[type='range'], input[type='radio'], textarea");
    var sliderOptions = {
        '780': 'every day',
        '840': 'every three days',
        '900': 'every week',
        '960': 'manually only',
        '0': 'every time you start Opera'
    }

    // Set the preference values for each field
    function savePrefs (event) {
        if (event.target.name == 'display-reports-by') {
            widget.preferences.setItem(event.target.name, event.target.id.replace('display-reports-by-', ''));
        } else if (event.target.name == 'update-interval') {
            widget.preferences.setItem('update-interval', event.target.value);
        } else if (event.target.name == 'prefixr-exclude') {            
            var sites = $('#prefixr-exclude').val(); 
            
            widget.preferences.setItem('prefixr-exclude', JSON.stringify(sites.split(/\r?\n/)))            
        } else widget.preferences.setItem(event.target.name, event.target.value);
    }

    // Get the preference values from the widget object
    function loadPrefs() {
        for (var i = 0; i < fields.length; i++) {
            var field = fields[i];
            if (typeof widget.preferences[field.name] !== "undefined") {
                if (field.getAttribute('type') == 'radio') {
                    if (widget.preferences.getItem(field.name) == field.value) field.checked = 'checked';
                } else if (field.id == 'prefixr-exclude') {
                    if ( widget.preferences.getItem('prefixr-exclude') ) {
                        try {
                            var excluded_sites = JSON.parse(widget.preferences.getItem('prefixr-exclude'));
                            
                            field.value = excluded_sites.join('\n');
                        } catch(e) {}
                    } else widget.preferences.setItem('prefixr-exclude', '[]')  
                } else field.value = widget.preferences.getItem(field.name)
            }
            
            field.addEventListener("change", savePrefs, false);
        }

        updateIntervalValue();
    }

    function readableInterval (minutes) {
        var minutes = parseInt(minutes),
              readable,
              prepend = 'every ';

        if ( minutes == 60 ) readable = 'hour';
        else if ((minutes > 720 && minutes % 60 == 0) || minutes == 0) readable = sliderOptions[minutes], prepend = '';
        else if ( minutes == 30 ) readable = 'half hour';
        else if ( minutes % 60 == 0 ) readable = (minutes / 60) + ' hours';
        else if ( minutes % 60 == 30 ) readable = (minutes - 30) / 60 + '.5 hours';
        else readable = minutes + ' minutes';

        return prepend + readable;
    }

    // That function shows update-interval's value on a visible HTML element
    function updateIntervalValue () {
        var interval = parseInt(document.getElementById("update-interval").value);

        document.getElementById("update-interval-value").innerText = readableInterval(interval);
    }

    // when the page is loaded, get extension preferences and assign them into correct input elements
    window.addEventListener("load", function() {
        loadPrefs()

        if (location.hash == '' || !document.getElementById(location.hash.replace('#', ''))) location.hash = 'preferences'
        else document.getElementById(location.hash.replace('#', '')).className = 'active';

        var sections = document.querySelectorAll("section"),
              nav = document.getElementById('nav'),
              currentSection = document.getElementById(location.hash.replace('#', ''));

        currentSection.className = 'active';

        for (i = 0; i < sections.length; i++) {
            var thisID = sections[i].id;
            activeClass = ('#' + thisID == location.hash ? ' class="active"' : '');

            nav.innerHTML += '<a href="#' +thisID + '" id="' +thisID + '-tab"' +activeClass+ '>' +thisID+ '</a>';
        }
    }, false);

    // when update interval is changed, update the value in the isible area
    document.getElementById("update-interval").addEventListener("change", updateIntervalValue, false);

    document.getElementById('update').addEventListener('click', function() {
        var loading = document.createElement('img'),
              update_button = document.getElementById('update');

        loading.src = '../images/loading.png';
        loading.id = 'loading_spinner';

        if (!document.getElementById('loading_spinner')) update_button.parentNode.insertBefore(loading, update_button.nextSibling);

        var updated = update(function(u) {
            if (document.getElementById('loading_spinner')) loading.parentNode.removeChild(loading);

            if (u == 2) $.modal('The CSS patches file was successfully updated!', { overlayClose: true });
            else if (u == 1) $.modal('No changes have been made to the CSS patches file since you last updated it.', { overlayClose: true });
            else $.modal('There was an error updating the CSS patches file' + (u != 0 ? ': \n\n' + u : '.'), { overlayClose: true });
        });
    }, false)

    function freezeClick(e) {
        e.preventDefault()
    }

    window.addEventListener('hashchange', function() {
        var lastTab = document.querySelector('a.active'),
              lastSection = document.querySelector('section.active'),
              currentHash = location.hash.replace('#', '') || '',
              currentTab = document.getElementById(currentHash + '-tab'),
              currentSection = document.getElementById(currentHash);

        if (currentHash == '' || !currentSection) { // don't allow the URL to change to an empty hash
            location.hash = 'preferences';
            return;
        }

        lastTab.className = '';
        lastSection.className = 'inactive';
        currentTab.className = 'active';

        // cancel any click events temporarily to fix the problem of tabs not working after you click a non-active tab during animation
        window.addEventListener('click', freezeClick, false);

        setTimeout(function() {
            lastSection.className = '';
            currentSection.className = 'active';

            // remove the "click freeze"
            window.removeEventListener('click', freezeClick, false);
        }, 600)
    }, false);

    // OAuth authentication

    if ( isLoggedIn() ) {
        $('#connected').removeClass('hide');
        $('#loading').attr('class', 'hide');
    } else {
        $('#auth').removeClass('hide');
        $('#loading').attr('class', 'hide');
    }

    // disconnect from your Twitter account
    $('#disconnect').click(function(e) {
        e.preventDefault ();

        $('#connected').fadeOut(500, function() {
            widget.preferences.access_token = ''; // remove the access token from local storage

            $('#auth').removeClass('hide');
            $('#auth').css('opacity', 0).animate({
                opacity: 1
            }, 650);
        });
    });

    $('#auth').bind('submit', function() {
        $.modal ('Click the "<strong>Sign in with Twitter</strong>" button before entering a PIN number.', { overlayClose: true });

        return false;
    });

    $('#twitter-login').click(function() { // Twitter OAuth
        oauth = new OAuth(CONFIG.twitter);
        oauth.fetchRequestToken(function(url) {
            window.open(url, 'authorise', 'width=700,height=400,resizable=no');
        }, failureHandler);

        $.modal ('A window should appear asking you to authorize this app on Twitter. After authorizing "Fix the Web", copy the PIN number Twitter gives you and paste it into the text box below the sign in button.', {maxWidth: Math.abs(window.innerWidth - 150), overlayClose: true})

        $('#auth').unbind('submit'); // detach the previously attached event handler

        $('#auth').bind('submit', function() { // add new event handler
            var pin = $('#pin-number', this).val();

            if (!pin || !pin.length) $.modal('Please enter the PIN number you got from Twitter.', { overlayClose: true })
            else {
                $('#auth').fadeTo(500, 0.4);

                oauth.setVerifier (pin);

                oauth.fetchAccessToken(function(data) {
                    var query_string = parseQueryString(data.text),
                          oauth_access_token = query_string.oauth_token || '',
                          oauth_access_secret = query_string.oauth_token_secret || '';

                    widget.preferences.access_token = oauth_access_token + '|' + oauth_access_secret;

                    // hide authorization form and show the "logged in" paragraph
                    $('#auth').addClass('hide');
                    $('#connected').removeClass('hide');

                    $.modal('You are signed in!', { overlayClose: true });
                }, failureHandler);
            }

            return false;
        });

        return false;
    });

    function failureHandler (data) { data ? console.log(data) : console.log('Request failed') }

    // parses a query string and returns
    function parseQueryString (a,b,c,d,e) {for(b=/[?&]?([^=]+)=([^&]*)/g,c={},e=decodeURIComponent;d=b.exec(a.replace(/\+/g,' '));c[e(d[1])]=e(d[2]));return c;}
    </script>
</body>
</html>