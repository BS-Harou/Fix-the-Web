<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="../images/icon-18.png" />
    <title data-i18n>{{options}} | Fix the Web</title>

    <style type="text/css">
        @import 'styles/styles.css';
        @import 'styles/special.css';
    </style>
</head>
<body>
    <div id="nav"></div><!--This tab bar is automatically filled with JS.-->

    <!-- To create a new tab, simply create a new <section> element with an ID. The ID will be the title of the tab. -->
    <section id="options">
        <h1>Fix the Web <span class="light" data-i18n> {{options}}</span></h1>

        <form id="prefs-form">
                <div class="sub_section">
                    <label><span data-i18n>{{check_for_updates}}</span>
                        <input type="range" min="0" max="960" step="60" name="update-interval" id="update-interval" />
                        <em><span id="update-interval-value"></span></em>
                    </label>

                    <div>
                        <div id="update" data-i18n>{{check_for_updates_now}}</div>
                    </div>
                </div>

                <p class="sub_section">
                    <span data-i18n>{{show_reports_count_by}}:</span>
                    <input type="radio" id="display-reports-by-domain" name="display-reports-by" value="domain" />
                    <label for="display-reports-by-domain">
                        <strong data-i18n>{{domain}}</strong>
                    </label>
                    <input type="radio" id="display-reports-by-page" name="display-reports-by" value="page" />
                    <label for="display-reports-by-page">
                        <strong data-i18n>{{page}}</strong>
                    </label>
                </p>
                <div class="sub_section">
                    <span data-i18n>{{css_prefixr}}</span>
                    <input type="radio" name="prefixr" value="true" id="prefixr-on" />
                    <label for="prefixr-on">
                        <strong data-i18n>{{enable}}</strong>
                    </label>
                    <input type="radio" name="prefixr" value="false" id="prefixr-off" />
                    <label for="prefixr-off">
                        <strong data-i18n>{{disable}}</strong>
                    </label>

                    <div>
                        <label for="prefixr-exclude" data-i18n>{{prefixr_exclude}}:</label>
                        <textarea data-i18n-attr="title" name="prefixr-exclude" id="prefixr-exclude" cols="60" rows="7" title="{{one_site_per_line}}" placeholder="exclude.com"></textarea>
                    </div>
                </div>
                <div class="sub_section">
                    <span data-i18n>{{browser_id}}</span> (<abbr data-i18n data-i18n-attr="title" title="{{browser_id_info}}">{{about}}</abbr>): 
                    
                    <input type="radio" name="browser-id" value="opera" id="as-opera" />
                    <label for="as-opera">
                        <strong data-i18n>{{as_opera}}</strong>
                    </label>
                    
                    <input type="radio" name="browser-id" value="ie" id="as-ie" />
                    <label for="as-ie">
                        <strong data-i18n>{{as_ie}}</strong>
                    </label>
                    
                    <input type="radio" name="browser-id" value="firefox" id="as-firefox" />
                    <label for="as-firefox">
                        <strong data-i18n>{{as_ff}}</strong>
                    </label>
                    
                    <input type="radio" name="browser-id" value="chrome" id="as-chrome" />
                    <label for="as-chrome">
                        <strong data-i18n>{{as_chrome}}</strong>
                    </label>
                </div>
        </form>
        <!--
    </section>
    <section id="authenticate">-->
<!--        <h1>Fix the Web <span class="light"> Authentication</span></h1>-->
        <form id="auth" class="hide sub_section">
            <p>
                <a href="#" id="twitter-login"></a>
            </p>

            <p>
                <input type="text" placeholder="PIN number" size="30" id="pin-number" required="required" />
                <button type="submit" data-i18n>{{connect}}</button>
            </p>

            <button disabled="disabled" data-i18n>{{connect_with_opera_account}}</button>
            <em data-i18n>({{not_possible_yet}})</em>
        </form>

        <p id="loading"><img src="../images/loading-circle.png" alt="{{loading}}" title="{{loading}}..." /></p>

        <p id="connected" class="hide" data-i18n>{{you_are_connected}} <strong><a href="#" id="disconnect" data-i18n>{{disconnect}}</a></strong></p>

        <ul id="recent-posts"></ul><!--populated by Javascript-->
    </section>
    <section id="about">
        <h1>Fix the Web <span class="light" data-i18n> {{about}}</span></h1>

        <p data-i18n>{{contribute_to_the_project}}:</p>

        <ul data-i18n>
            <li><strong><a href="http://my.opera.com/fix-the-web">{{opera_ftw_group}}</a></strong> ({{opera_ftw_group_info}})</li>
            <li><strong><a href="http://www.operaturkiye.net/fix-the-web">{{home_page}}</a></strong> ({{home_page_info}})</li>
            <li><strong><a href="http://github.com/cyberstream/Fix-the-Web">{{main_repo}}</a></strong></li>
            <li><strong><a href="http://github.com/cyberstream/Fix-the-Web-Server-Side">{{server_side_repo}}</a></strong></li>
            <li><strong><a href="http://github.com/cyberstream/Fix-the-Web-CSS-Patches">{{css_patches}}</a></strong> ({{css_patches_info}})</li>
        </ul>
            
        <div id="columnize">            
            <div>
                <h4 data-i18n>{{contributors}}:</h4>
            
                <ul>
                    <li><strong><a href="http://my.opera.com/cyberstream">cyberstream</a></strong> <a href="mailto:cyberstream@myopera.com" data-i18n>({{email}})</a></li>
                    <li><strong><a href="http://my.opera.com/greench">greench</a></strong> <a href="mailto:greench@myopera.com" data-i18n>({{email}})</a></li>
                    <li><strong><a href="http://my.opera.com/inbuster">inbuster</a></strong> <a href="mailto:inbuster@myopera.com" data-i18n>({{email}})</a></li>
                    <li><strong><a href="http://my.opera.com/metude">metude</a></strong> <a href="mailto:metude@myopera.com" data-i18n>({{email}})</a></li>
                    <li><strong><a href="http://my.opera.com/zahek">zahek</a></strong> <a href="mailto:zahek@myopera.com" data-i18n>({{email}})</a></li>
                    <li><strong><a href="http://my.opera.com/BS-Harou">BS-Harou</a></strong></li>
                </ul>
            </div>
            
            <div>
                <h4 data-i18n>{{thanks}}:</h4>
                
                <ul>
                    <li data-i18n><strong><a href="http://my.opera.com/AntonDiaz">AntonDiaz</a></strong> ({{anton_diaz_info}})</li>
                    <li data-i18n><strong><a href="http://my.opera.com/Christoph142">Christoph142</a></strong> ({{christoph_info}})</li>
                    <li data-i18n><strong><a href="http://my.opera.com/celeborn1">Yiğit Ateş</a></strong> ({{celeborn_info}})</li>
                </ul>
            </div>
        </div>
    </section>

    <footer>
        <a href="reports.html" data-i18n>{{recent_reports}}</a>
    </footer>

    <script type="text/javascript" src="scripts/jsOAuth-1.3.3.min.js"></script>
    <script type="text/javascript" src="scripts/jquery-1.6.4.min.js"></script>
    <script type="text/javascript" src="scripts/locale.js"></script>
    <script type="text/javascript" src="scripts/translate.js"></script>
    <script type="text/javascript" src="scripts/misc.js"></script>
    <script type="text/javascript" src="scripts/jquery.simplemodal.1.4.2.min.js"></script>
    <script type="text/javascript">
        $.support.cors = true;

        // get recent blog posts from Fix the Web's blog
        $(function() {
            $.get('http://my.opera.com/fix-the-web/xml/rss/blog', function(data) {
                var items = $('item', data);

                // populate the list with the the 7 most recent blog posts
                for (i in items) {
                    if ( i > 7 ) break;
                    if ( !items[i] || typeof items[i].getElementsByTagName != 'function' || i == 'context' ) continue;

                    var link = items[i].getElementsByTagName('link')[0].firstChild.nodeValue,
                          title = items[i].getElementsByTagName('title')[0].firstChild.nodeValue,
                          time = items[i].getElementsByTagName('pubDate')[0].firstChild.nodeValue
                          
                    try {
                        time = new Date(time);
                        
                        switch( Math.floor ((new Date() - time) / (1000 * 60 * 60 * 24)) ) { // this is the number of days since the article was posted
                            case 0 :
                                time = i18n.posted_today
                                break;
                            case 1 :
                                time = i18n.posted_yesterday
                                break;
                            case 2 : 
                                time = i18n.posted_two_days_ago
                                break;
                            case 3 :
                                time = i18n.posted_three_days_ago
                                break;
                            case 4 :
                                time = i18n.posted_four_days_ago
                                break;
                            case 5 :
                                time = i18n.posted_five_days_ago
                                break;
                            case 6 : 
                                time = i18n.posted_six_days_ago
                                break;
                            case 7 :
                                time = i18n.posted_a_week_ago
                                break;
                            default:
                                time = time.toLocaleDateString();
                        }                         
                        
                    } catch (e) {
                        time = '';
                    }

                    $('<li><a href="' +link+ '" title="' + i18n.click_to_read_more + '" target="_blank">' +title+ '</a> <strong class="light">' +time+ '</strong></li>').appendTo('#recent-posts');
                }
                
                if ($('#recent-posts').children().length) {
                    $('<h3 id="blog-header">' + i18n.latest_posts + '</h3>').insertBefore('#recent-posts')

                    var k = -1,
                          posts = $('#recent-posts').children();

                    function loop () {
                        var previous = k;

                        if (k + 1 == posts.length) k = 0;
                        else k++;

                        $(posts[previous]).removeClass('current');
                        $(posts[k]).addClass('current');

                        setTimeout(loop, 4000);
                    }

                    loop();
                }
            });
        });

    var form = document.getElementById("prefs-form"),
          fields = form.querySelectorAll("input[type='range'], input[type='radio'], textarea");
    var sliderOptions = {
        '780': i18n.every_day,
        '840': i18n.every_three_days,
        '900': i18n.every_week,
        '960': i18n.manually_only,
        '0': i18n.browser_start
    }

    // Set the preference values for each field
    function savePrefs (event) {
        if (event.target.name == 'display-reports-by') {
            widget.preferences.setItem(event.target.name, event.target.id.replace('display-reports-by-', ''));
        } else if (event.target.name == 'update-interval') {
            widget.preferences.setItem('update-interval', event.target.value);
        } else if (event.target.name == 'prefixr-exclude') {            
            var sites = $('#prefixr-exclude').val(); 
            
            widget.preferences.setItem('prefixr-exclude', JSON.stringify(sites.split(/\r?\n/)))            
        } else widget.preferences.setItem(event.target.name, event.target.value);
    }

    // Get the preference values from the widget object
    function loadPrefs() {
        for (var i = 0; i < fields.length; i++) {
            var field = fields[i];
            if (typeof widget.preferences[field.name] !== "undefined") {
                if (field.getAttribute('type') == 'radio') {
                    if (widget.preferences.getItem(field.name) == field.value) field.checked = 'checked';
                } else if (field.id == 'prefixr-exclude') {
                    if ( widget.preferences.getItem('prefixr-exclude') ) {
                        try {
                            var excluded_sites = JSON.parse(widget.preferences.getItem('prefixr-exclude'));
                            
                            field.value = excluded_sites.join('\n');
                        } catch(e) {}
                    } else widget.preferences.setItem('prefixr-exclude', '[]')  
                } else field.value = widget.preferences.getItem(field.name)
            }
            
            field.addEventListener("change", savePrefs, false);
        }

        updateIntervalValue();
    }

    function readableInterval (minutes) {
        var minutes = parseInt(minutes),
              readable;

        if ( minutes == 60 ) readable = i18n.every_hour;
        else if ((minutes > 720 && minutes % 60 == 0) || minutes == 0) readable = sliderOptions[minutes];
        else if ( minutes == 30 ) readable = i18n.every_half_hour;
        else if ( minutes % 60 == 0 ) readable = (minutes / 60) + ' ' + i18n.hours;
        else if ( minutes % 60 == 30 ) readable = (minutes - 30) / 60 + '.5 ' + i18n.hours;
        else readable = minutes + ' ' + i18n.minutes;

        return readable;
    }

    // That function shows update-interval's value on a visible HTML element
    function updateIntervalValue () {
        var interval = parseInt(document.getElementById("update-interval").value);

        document.getElementById("update-interval-value").innerText = readableInterval(interval);
    }

    // when the page is loaded, get extension preferences and assign them into correct input elements
    window.addEventListener("load", function() {
        loadPrefs()

        if (location.hash == '' || !document.getElementById(location.hash.replace('#', ''))) location.hash = 'options'
        else document.getElementById(location.hash.replace('#', '')).className = 'active';

        var sections = document.querySelectorAll("section"),
              nav = document.getElementById('nav'),
              currentSection = document.getElementById(location.hash.replace('#', ''));

        currentSection.className = 'active';

        for (i = 0; i < sections.length; i++) {
            var thisID = sections[i].id;
            activeClass = ('#' + thisID == location.hash ? ' class="active"' : '');

            nav.innerHTML += '<a href="#' +thisID + '" id="' +thisID + '-tab"' +activeClass+ '>' +i18n[thisID.toLowerCase()]+ '</a>';
        }
    }, false);

    // when update interval is changed, update the value in the isible area
    document.getElementById("update-interval").addEventListener("change", updateIntervalValue, false);

    document.getElementById('update').addEventListener('click', function() {
        var loading = document.createElement('img'),
              update_button = document.getElementById('update');

        loading.src = '../images/loading.png';
        loading.id = 'loading_spinner';

        if (!document.getElementById('loading_spinner')) update_button.parentNode.insertBefore(loading, update_button.nextSibling);

        var updated = update(function(u) {
            if (document.getElementById('loading_spinner')) loading.parentNode.removeChild(loading);

            if (u == 2) $.modal(i18n.css_patches_was_updated, { overlayClose: true });
            else if (u == 1) $.modal(i18n.css_patches_file_unchanged, { overlayClose: true });
            else $.modal(i18n.css_patches_update_error + (u != 0 ? ': \n\n' + u : '.'), { overlayClose: true });
        });
    }, false)

    function freezeClick(e) {
        e.preventDefault()
    }

    window.addEventListener('hashchange', function() {
        var lastTab = document.querySelector('a.active'),
              lastSection = document.querySelector('section.active'),
              currentHash = location.hash.replace('#', '') || '',
              currentTab = document.getElementById(currentHash + '-tab'),
              currentSection = document.getElementById(currentHash);

        if (currentHash == '' || !currentSection) { // don't allow the URL to change to an empty hash
            location.hash = 'options';
            return;
        }

        lastTab.className = '';
        lastSection.className = 'inactive';
        currentTab.className = 'active';

        // cancel any click events temporarily to fix the problem of tabs not working after you click a non-active tab during animation
        window.addEventListener('click', freezeClick, false);

        /*setTimeout*/(function() {
            lastSection.className = '';
            currentSection.className = 'active';

            // remove the "click freeze"
            window.removeEventListener('click', freezeClick, false);
        })()
    }, false);

    // OAuth authentication

    if ( isLoggedIn() ) {
        $('#connected').removeClass('hide');
        $('#loading').attr('class', 'hide');
    } else {
        $('#auth').removeClass('hide');
        $('#loading').attr('class', 'hide');
    }

    // disconnect from your Twitter account
    $('#disconnect').click(function(e) {
        e.preventDefault ();

        $('#connected').fadeOut(500, function() {
            widget.preferences.access_token = ''; // remove the access token from local storage

            $('#auth').removeClass('hide');
            $('#auth').css('opacity', 0).animate({
                opacity: 1
            }, 650);
        });
    });

    $('#auth').bind('submit', function() {
        $.modal (i18n.sign_in_error, { overlayClose: true });

        return false;
    });

    $('#twitter-login').click(function() { // Twitter OAuth
        oauth = new OAuth(CONFIG.twitter);
        oauth.fetchRequestToken(function(url) {
            window.open(url, 'authorise', 'width=700,height=400,resizable=no');
        }, failureHandler);

        $.modal (i18n.sign_in_info, {maxWidth: Math.abs(window.innerWidth - 150), overlayClose: true})

        $('#auth').unbind('submit'); // detach the previously attached event handler

        $('#auth').bind('submit', function() { // add new event handler
            var pin = $('#pin-number', this).val();

            if (!pin || !pin.length) $.modal(i18n.no_pin_error, { overlayClose: true })
            else {
                $('#auth').fadeTo(500, 0.4);

                oauth.setVerifier (pin);

                oauth.fetchAccessToken(function(data) {
                    var query_string = parseQueryString(data.text),
                          oauth_access_token = query_string.oauth_token || '',
                          oauth_access_secret = query_string.oauth_token_secret || '';

                    widget.preferences.access_token = oauth_access_token + '|' + oauth_access_secret;

                    // hide authorization form and show the "logged in" paragraph
                    $('#auth').addClass('hide');
                    $('#connected').removeClass('hide');

                    $.modal(i18n.signed_in, { overlayClose: true });
                }, failureHandler);
            }

            return false;
        });

        return false;
    });

    function failureHandler (data) { data ? console.log(data) : console.log(i18n.request_failed) }

    // parses a query string and returns
    function parseQueryString (a,b,c,d,e) {for(b=/[?&]?([^=]+)=([^&]*)/g,c={},e=decodeURIComponent;d=b.exec(a.replace(/\+/g,' '));c[e(d[1])]=e(d[2]));return c;}
    </script>
</body>
</html>