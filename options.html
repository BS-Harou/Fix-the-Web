<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="images/icon-18.png" />
    <title>Options | Fix the Web</title>
    
    <style type="text/css">
        @import 'modal_styles.css';
        
    body {
        padding:0;
        margin:0;
        background:rgb(245, 245, 245);
        font-family: "arial", "lucida grande", "lucida sans unicode", "bitstream vera sans", "dejavu sans", "trebuchet ms", sans-serif;
        color:#111;
    }
    
    a, a:link {
        color: #111;
        text-decoration: none;
    }
    
    section a, section a:link { color: #389CFE }    
    a:hover { text-decoration: underline }
    
    #prefs-form h1 {
        border-bottom:1px solid rgb(230,230,230 );
        margin:2px 0;
        padding:5px;
        clear:both;
    }
    
    #prefs-form input[type=range] {
        width:300px;
    }
    
    #update {
        margin:10px 0 0 0;
        padding:3px;
        background:#dbe4ff;
        border:1px solid #416fe2;
        display:inline-block;
        border-radius:5px;
        cursor:pointer;
        font-weight:bold;
        -o-transition:background-color 400ms ease-in-out;
        text-shadow:0 0 12px #fff, 0 1px 1px #ddd;
    }
    
    #update:hover {
        background: #7298f7;
    }
    
    #loading_spinner {
        width:28px; 
        height:28px; 
        margin-left: 5px;
        position:relative; 
        top:8px;
    }
    
    #nav {
        background:-o-linear-gradient(top, #eee, #ccc); 
        padding:10px 5px 3px 5px; 
        z-index:10;
        border-bottom:1px solid #aaa;
    }
    
    #nav a:not(.active):hover {
        background: #c1c1c1;
        padding-bottom: 3px;
    }
    
    #nav a {
        padding:5px 7px; 
        text-decoration:none; 
        font-weight:bold; 
        font-size:14px; 
        text-transform:uppercase;
        text-shadow: 0 1px 1px #fff;
    }    
    #nav a.active { 
        background:#fff;
        border-radius: 6px 6px 0 0;
        box-shadow: 0 -1px 1px #bbb;
    }
    
    section {
        width:80%;
        position:relative;
        margin: 0 auto;
        z-index:0;
        opacity:0;
        display:none;
        -o-transition: opacity 0.6s ease;
    }
    
    section.active {
        display: block;
        opacity: 1;        
    }
    
    section.inactive {
        display:block;
        opacity: 0;
    }
    
    #nav a.active:before, #nav a.active:after {
        content:''; 
        position: absolute; 
        padding: 0px; 
        height: 7px; 
        width: 6px; 
        border: 1px solid #ff0000;
    }
    
    #nav a.active:before {  
        margin-left: -15px; 
        margin-top: 13px; 
        border-radius: 0 0 5px 0; 
        border-color: transparent #ccc #aaa transparent; 
        box-shadow: 5px 5px 5px #fff;
    }
    
    #nav a.active:after { 
        margin-left: 7px; 
        margin-top: 13px; 
        border-radius: 0 0 0 5px; 
        border-color: transparent transparent #aaa #ccc; 
        box-shadow: -5px 5px 0 #fff;
    }
    
    .light {color: #888}
    
    #display-reports-by-domain, #display-reports-by-page {
        position: absolute; 
        opacity: 0;
    }
    
    #display-reports-by-domain + label,#display-reports-by-page + label {
        cursor: pointer; 
        padding: 2px 5px; 
        padding-right:0; 
        margin: 0 2px; 
        border-radius:5px; 
        border: 1px solid transparent; 
        text-transform:uppercase; 
        font-size:.8em;
    }
    
    #display-reports-by-domain:checked + label, #display-reports-by-page:checked + label {
        background:-o-linear-gradient(top, #fff, #ccc); 
        border: 1px solid #aaa; 
        text-shadow: 0 1px 1px #fff; 
        box-shadow: 0 0 3px #bbb; 
        color:#0000cc;
    }
    
    #twitter-login {background-image: url('images/signin_twitter.png')}
    #facebook-login {background-image: url('images/signin_facebook.png')}
    
    #facebook-login, #twitter-login {
        width: 150px; 
        height: 22px; 
        display: inline-block; 
        background-position: 0 0;
    }
    
    #facebook-login:hover, #twitter-login:hover {background-position:0 -24px}
    #facebook-login:active, #twitter-login:active {background-position: 0 -48px;}
    
    ul {
        padding: 3px 0;
        background: #eaeaea; 
        text-shadow: 0 1px 1px #fff; 
        border-radius: 5px; 
        border:1px solid #ddd;
        display: inline-block;
        margin: 0;
    }
    
    ul li {
        padding: 2px 5px;
        list-style:none;
    }
    
    ul li:nth-child(2n) {background: #fff; }
    </style>
</head>
<body>
    <div id="nav"></div><!--This tab bar is automatically filled with JS.-->
    
    <!-- To create a new tab, simply create a new <section> element with an ID. The ID will be the title of the tab. -->
    <section id="preferences">
        <h1>Fix the Web <span class="light"> Options</span></h1>
        
        <form id="prefs-form">            
                <label>Check for updates to the patches script every 
                    <input type="range" min="30" max="720" step="15" name="update-interval" id="update-interval"/>
                    <span id="update-interval-in-minute"></span> minutes
                </label>

                <div id="update">update patches script now</div>

                <p>
                    Show reports count in the toolbar icon badge by
                    <input type="radio" id="display-reports-by-domain" name="display-reports-by" value="domain" />
                    <label for="display-reports-by-domain">
                        <strong>domain</strong>
                    </label>
                    <input type="radio" id="display-reports-by-page" name="display-reports-by" value="page" />
                    <label for="display-reports-by-page">
                        <strong>page</strong>
                    </label>
                </p>
        </form>
    </section>

    <section id="authenticate">
        <h1>Fix the Web <span class="light"> Authentication</span></h1>
        
        <form id="auth">
            <p>            
                <a href="#" id="twitter-login"></a>
                <a href="#" id="facebook-login"></a>
            </p>
            
            <p>
                <input type="text" placeholder="PIN number" size="30" id="pin-number" required="required" />
                <button type="submit">Connect</button>
            </p>
            
            <button disabled="disabled">Connect with your Opera Account</button> 
            <em>(Opera's API is not capable of doing this yet. Login with Twitter or Facebook.)</em>
        </form>
    </section>
    <section id="about">
        <h1>Fix the Web <span class="light"> About</span></h1>
        
        <p>Fix the Web is open source. You can contribute to the project on Github:</p>
        
        <ul>
            <li><strong><a href="http://github.com/cyberstream/Fix-the-Web">Main extension files repository</a></strong></li>
            <li><strong><a href="http://github.com/cyberstream/Fix-the-Web-Server-Side">Server-side files</a></strong></li>
            <li><strong><a href="http://github.com/cyberstream/Fix-the-Web">Patches script</a></strong> (If you want to patch a bug on a website, add the fix to the <em>patches.js</em> file in this repo)</li>
        </ul>
        
        <p><strong>Contributors:</strong></p>
        
        <ul>
            <li><strong><a href="http://my.opera.com/cyberstream">cyberstream</a></strong> <a href="mailto:cyberstream@myopera.com">(email)</a></li>
            <li><strong><a href="http://my.opera.com/greench">greench</a></strong> <a href="mailto:greench@myopera.com">(email)</a></li>
            <li><strong><a href="http://my.opera.com/inbuster">inbuster</a></strong> <a href="mailto:inbuster@myopera.com">(email)</a></li>
            <li><strong><a href="http://my.opera.com/metude">metude</a></strong> <a href="mailto:metude@myopera.com">(email)</a></li>           
            <li><strong><a href="http://my.opera.com/zahek">zahek</a></strong> <a href="mailto:zahek@myopera.com">(email)</a></li>
        </ul>
    </section>
    
    <script type="text/javascript" src="scripts/background.js"></script>
    <script type="text/javascript" src="scripts/jsOAuth-1.3.3.min.js"></script>
    <script type="text/javascript" src="scripts/jquery-1.6.4.min.js"></script>
    <script type="text/javascript" src="scripts/jquery.simplemodal.1.4.2.min.js"></script>
    <script type="text/javascript">
    var form = document.getElementById("prefs-form"),
          fields = form.querySelectorAll("input[type='range'], input[type='radio']");
    
    // Set the preference values for each field
    function savePrefs (event) {
        if (event.target.name == 'display-reports-by') widget.preferences.setItem(event.target.name, event.target.id.replace('display-reports-by-', ''));
        else widget.preferences.setItem(event.target.name, event.target.value);
    }
    
    // Get the preference values from the widget object
    function loadPrefs() {
        for (var i = 0; i < fields.length; i++) {
            var field = fields[i];
            if (typeof widget.preferences[field.name] !== "undefined") {
                if (field.name == 'display-reports-by') {
                    if (widget.preferences.getItem(field.name) == field.value) field.checked = 'checked';
                } else field.value = widget.preferences.getItem(field.name);
                
                field.addEventListener("change", savePrefs, false);
            }
        }
        
        updateIntervalValue();
    }
    
    // That function shows update-interval's value on a visible HTML element
    function updateIntervalValue(){
        document.getElementById("update-interval-in-minute").innerText = document.getElementById("update-interval").value;
    }
    
    // when the page is loaded, get extension preferences and assign them into correct input elements
    window.addEventListener("load", function() {
        loadPrefs()
        
        if (location.hash == '') location.hash = 'preferences'
        else document.getElementById(location.hash.replace('#', '')).className = 'active';
        
        var sections = document.querySelectorAll("section"),
              nav = document.getElementById('nav'),
              currentSection = document.getElementById(location.hash.replace('#', ''));
              
        currentSection.className = 'active';
        
        for (i = 0; i < sections.length; i++) {
            var thisID = sections[i].id;
            activeClass = ('#' + thisID == location.hash ? ' class="active"' : '');
            
            nav.innerHTML += '<a href="#' +thisID + '" id="' +thisID + '-tab"' +activeClass+ '>' +thisID+ '</a>';
        }
    }, false);
    
    // when update interval is changed, update the value in the isible area
    document.getElementById("update-interval").addEventListener("change", updateIntervalValue, false);
    
    document.getElementById('update').addEventListener('click', function() { 
        var loading = document.createElement('img'),
              update_button = document.getElementById('update');
        
        loading.src = 'images/loading.png';
        loading.id = 'loading_spinner';
        
        if (!document.getElementById('loading_spinner')) update_button.parentNode.insertBefore(loading, update_button.nextSibling);        
        
        var updated = update(function(u) {
            if (document.getElementById('loading_spinner')) loading.parentNode.removeChild(loading);

            if (u == 2) alert('The patches script was successfully updated!');
            else if (u == 1) alert('No changes have been made to the patches script since you last updated it.');
            else alert('There was an error updating the patches script' + (u != 0 ? ': \n\n' + u : '.'));            
        });
    }, false)
    
    window.addEventListener('hashchange', function() {
        var lastTab = document.querySelector('a.active'),
              lastSection = document.querySelector('section.active'),
              currentHash = location.hash.replace('#', '') || '',
              currentTab = document.getElementById(currentHash + '-tab'),
              currentSection = document.getElementById(currentHash);
              
        if (currentHash == '') { // don't allow the URL to change to an empty hash
            location.hash = '#authenticate';
            return;
        }
        
        lastTab.className = '';
        lastSection.className = 'inactive';
        currentTab.className = 'active';
        
        setTimeout(function() {
            lastSection.className = '';
            currentSection.className = 'active';
        }, 600)
    }, false);
    
    // OAuth authentication
    
    var twitterConfig = {
        consumerKey: "frKRutacGx6VUkMhwQeJ6Q",
        consumerSecret: "aUEFth57HGgRQC0pYjkCwrIZUpROLCVvPBZsM4dg",

        requestTokenUrl: "https://api.twitter.com/oauth/request_token",
        authorizationUrl: "https://api.twitter.com/oauth/authorize",
        accessTokenUrl: "https://api.twitter.com/oauth/access_token"
    };
    
    $('#twitter-login').click(function() { // Twitter OAuth
        oauth = new OAuth(twitterConfig);
        oauth.fetchRequestToken(openAuthoriseWindow, failureHandler);
        
        return false;
    });
    
    $('#auth').submit(function() {
        var pin = $('#pin-number', this).val();
        
        if (!pin || !pin.length) $.modal('Please enter a PIN number.')
        else {
            $.modal('Got this: ' + pin)
        }
        
        return false;
    });

    function openAuthoriseWindow(url) {
        var wnd = window.open(url, 'authorise', 'width=700,height=400,resizable=no');

        function waitForPin() {
            if ( wnd.closed ) {
                var pin = prompt( "Please enter your PIN", "" );
                oauth.setVerifier( pin );
                oauth.fetchAccessToken( getSomeData, failureHandler );
            } else {
                setTimeout( waitForPin, 100 );
            }
        }
    }

    function getSomeData() {
        oauth.get("https://api.twitter.com/oauth/something/?format=json", function (data) {
            console.log(data.text);
        }, failureHandler);
    }

    function failureHandler(data) { console.error(data); }
    </script>
</body>
</html>