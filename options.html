<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="images/icon-18.png" />
    <title>Options | Fix the Web</title>
    
    <style type="text/css">
        @import 'modal_styles.css';
        
    body {
        padding:0;
        margin:0;
        background:rgb(245, 245, 245);
        font-family: "arial", "lucida grande", "lucida sans unicode", "bitstream vera sans", "dejavu sans", "trebuchet ms", sans-serif;
        color:#111;
    }
    
    a, a:link {
        color: #111;
        text-decoration: none;
    }
    
    section a, section a:link { color: #389CFE }    
    a:hover { text-decoration: underline }
    
    #prefs-form h1 {
        border-bottom:1px solid rgb(230,230,230 );
        margin:2px 0;
        padding:5px;
        clear:both;
    }
    
    #prefs-form input[type=range] {
        width:300px;
    }
    
    #update {
        margin:10px 0 0 0;
        padding:3px;
        background:#dbe4ff;
        border:1px solid #416fe2;
        display:inline-block;
        border-radius:5px;
        cursor:pointer;
        font-weight:bold;
        -o-transition:background-color 400ms ease-in-out;
        text-shadow:0 0 12px #fff, 0 1px 1px #ddd;
    }
    
    #update:hover {
        background: #7298f7;
    }
    
    #loading_spinner {
        width:28px; 
        height:28px; 
        margin-left: 5px;
        position:relative; 
        top:8px;
    }
    
    #nav {
        background:-o-linear-gradient(top, #eee, #ccc); 
        padding:10px 5px 3px 5px; 
        z-index:10;
        border-bottom:1px solid #aaa;
    }
    
    #nav a:not(.active):hover {
        background: #c1c1c1;
        padding-bottom: 3px;
    }
    
    #nav a {
        padding:5px 7px; 
        text-decoration:none; 
        font-weight:bold; 
        font-size:14px; 
        text-transform:uppercase;
        text-shadow: 0 1px 1px #fff;
    }    
    #nav a.active { 
        background:#fff;
        border-radius: 6px 6px 0 0;
        box-shadow: 0 -1px 1px #bbb;
    }
    
    section {
        width:80%;
        position:relative;
        margin: 0 auto;
        z-index:0;
        opacity:0;
        display:none;
        -o-transition: opacity 0.6s ease;
    }
    
    section.active {
        display: block;
        opacity: 1;        
    }
    
    section.inactive {
        display:block;
        opacity: 0;
    }
    
    #nav a.active:before, #nav a.active:after {
        content:''; 
        position: absolute; 
        padding: 0px; 
        height: 7px; 
        width: 6px; 
        border: 1px solid #ff0000;
    }
    
    #nav a.active:before {  
        margin-left: -15px; 
        margin-top: 13px; 
        border-radius: 0 0 5px 0; 
        border-color: transparent #ccc #aaa transparent; 
        box-shadow: 5px 5px 5px #fff;
    }
    
    #nav a.active:after { 
        margin-left: 7px; 
        margin-top: 13px; 
        border-radius: 0 0 0 5px; 
        border-color: transparent transparent #aaa #ccc; 
        box-shadow: -5px 5px 0 #fff;
    }
    
    .light {color: #888}
    
    #display-reports-by-domain, #display-reports-by-page {
        position: absolute; 
        opacity: 0;
    }
    
    #display-reports-by-domain + label,#display-reports-by-page + label {
        cursor: pointer; 
        padding: 2px 5px; 
        padding-right:0; 
        margin: 0 2px; 
        border-radius:5px; 
        border: 1px solid transparent; 
        text-transform:uppercase; 
        font-size:.8em;
    }
    
    #display-reports-by-domain:checked + label, #display-reports-by-page:checked + label {
        background:-o-linear-gradient(top, #fff, #ccc); 
        border: 1px solid #aaa; 
        text-shadow: 0 1px 1px #fff; 
        box-shadow: 0 0 3px #bbb; 
        color:#0000cc;
    }
    
    #twitter-login {background-image: url('images/signin_twitter.png')}
    #facebook-login {background-image: url('images/signin_facebook.png')}
    
    #facebook-login, #twitter-login {
        width: 150px; 
        height: 22px; 
        display: inline-block; 
        background-position: 0 0;
    }
    
    #facebook-login:hover, #twitter-login:hover {background-position:0 -24px}
    #facebook-login:active, #twitter-login:active {background-position: 0 -48px;}
    
    ul {
        padding: 3px 0;
        background: #eaeaea; 
        text-shadow: 0 1px 1px #fff; 
        border-radius: 5px; 
        border:1px solid #ddd;
        display: inline-block;
        margin: 0;
    }
    
    ul li {
        padding: 2px 5px;
        list-style:none;
    }
    
    ul li:nth-child(2n) {background: #fff; }
    
    .hide { display: none; }
    
    #loading img {
        display:block; 
        margin: 0 auto;
    }
    
    footer {
        text-align:center;
        margin-top: 20px;            
    }
    
    footer a {
        background: -o-linear-gradient(bottom, #ddd, #fff); 
        color: #777;
        text-transform: uppercase; 
        padding: 2px 4px; 
        border-radius: 3px; 
        border: 1px solid #ccc; 
        font-size: 12px;
        font-weight: bold;
    }
    </style>
</head>
<body>
    <div id="nav"></div><!--This tab bar is automatically filled with JS.-->
    
    <!-- To create a new tab, simply create a new <section> element with an ID. The ID will be the title of the tab. -->
    <section id="preferences">
        <h1>Fix the Web <span class="light"> Options</span></h1>
        
        <form id="prefs-form">            
                <label>Check for updates to the CSS patches file every 
                    <input type="range" min="30" max="720" step="30" name="update-interval" id="update-interval"/>
                    <span id="update-interval-value"></span>
                </label>

                <div id="update">Check for new CSS patches now</div>

                <p>
                    Show reports count in the toolbar icon badge by
                    <input type="radio" id="display-reports-by-domain" name="display-reports-by" value="domain" />
                    <label for="display-reports-by-domain">
                        <strong>domain</strong>
                    </label>
                    <input type="radio" id="display-reports-by-page" name="display-reports-by" value="page" />
                    <label for="display-reports-by-page">
                        <strong>page</strong>
                    </label>
                </p>
        </form>
        <!--
    </section>
    <section id="authenticate">-->
<!--        <h1>Fix the Web <span class="light"> Authentication</span></h1>-->
        <hr />
        <form id="auth" class="hide">
            <p>            
                <a href="#" id="twitter-login"></a>
<!--                <a href="#" id="facebook-login"></a>-->
            </p>
            
            <p>
                <input type="text" placeholder="PIN number" size="30" id="pin-number" required="required" />
                <button type="submit">Connect</button>
            </p>
            
            <button disabled="disabled">Connect with your Opera Account</button> 
            <em>(Opera's API is not capable of doing this yet. In the meanwhile, login with Twitter.)</em>
        </form>
        
        <p id="loading"><img src="images/loading-circle.png" alt="loading" title="Loading..." /></p>
        
        <p id="connected" class="hide">You are connected to your Twitter account right now. <strong><a href="#" id="disconnect">disconnect</a></strong></p>
    </section>
    <section id="about">
        <h1>Fix the Web <span class="light"> About</span></h1>
        
        <p>Fix the Web is open source. You can contribute to the project on Github:</p>
        
        <ul>
            <li><strong><a href="http://my.opera.com/fix-the-web">My Opera <em>Fix the Web</em> Group</a></strong> (support, blog, forums, etc.)</li>
            <li><strong><a href="http://www.operaturkiye.net/fix-the-web">Home Page</a></strong> (still under construction)</li>
            <li><strong><a href="http://github.com/cyberstream/Fix-the-Web">Main extension files repository</a></strong></li>
            <li><strong><a href="http://github.com/cyberstream/Fix-the-Web-Server-Side">Server-side repository</a></strong></li>
            <li><strong><a href="http://github.com/cyberstream/Fix-the-Web-CSS-Patches">CSS Patches</a></strong> (If a website just needs CSS to be patched, then add the patch to the <em><strong>patches.json</strong></em> file in this repo. If the problematic website needs JS for the patch, place it in <em><strong>includes/</strong>patches.js</em> in the <a title="Fix the Web's Repository" href="http://github.com/cyberstream/Fix-the-Web">extension repo</a>.)</li>
        </ul>
        
        <p><strong>Contributors:</strong></p>
        
        <ul>
            <li><strong><a href="http://my.opera.com/cyberstream">cyberstream</a></strong> <a href="mailto:cyberstream@myopera.com">(email)</a></li>
            <li><strong><a href="http://my.opera.com/greench">greench</a></strong> <a href="mailto:greench@myopera.com">(email)</a></li>
            <li><strong><a href="http://my.opera.com/inbuster">inbuster</a></strong> <a href="mailto:inbuster@myopera.com">(email)</a></li>
            <li><strong><a href="http://my.opera.com/metude">metude</a></strong> <a href="mailto:metude@myopera.com">(email)</a></li>           
            <li><strong><a href="http://my.opera.com/zahek">zahek</a></strong> <a href="mailto:zahek@myopera.com">(email)</a></li>
        </ul>
    </section>
    
    <footer>
        <a href="index.html">Recent Reports List</a>
    </footer>
    
    <script type="text/javascript" src="scripts/background.js"></script>
    <script type="text/javascript" src="scripts/jsOAuth-1.3.3.min.js"></script>
    <script type="text/javascript" src="scripts/jquery-1.6.4.min.js"></script>
    <script type="text/javascript" src="scripts/jquery.simplemodal.1.4.2.min.js"></script>
    <script type="text/javascript">
    var form = document.getElementById("prefs-form"),
          fields = form.querySelectorAll("input[type='range'], input[type='radio']");
    
    // Set the preference values for each field
    function savePrefs (event) {
        if (event.target.name == 'display-reports-by') widget.preferences.setItem(event.target.name, event.target.id.replace('display-reports-by-', ''));
        else widget.preferences.setItem(event.target.name, event.target.value);
    }
    
    // Get the preference values from the widget object
    function loadPrefs() {
        for (var i = 0; i < fields.length; i++) {
            var field = fields[i];
            if (typeof widget.preferences[field.name] !== "undefined") {
                if (field.name == 'display-reports-by') {
                    if (widget.preferences.getItem(field.name) == field.value) field.checked = 'checked';
                } else field.value = widget.preferences.getItem(field.name);
                
                field.addEventListener("change", savePrefs, false);
            }
        }
        
        updateIntervalValue();
    }
    
    function readableInterval (minutes) {
        var minutes = parseInt(minutes),
              readable; 
        
        if ( minutes == 60 ) readable = 'hour';
        else if ( minutes == 30 ) readable = 'half hour';
        else if ( minutes % 60 == 0 ) readable = (minutes / 60) + ' hours';
        else if ( minutes % 60 == 30 ) readable = (minutes - 30) / 60 + '-1/2 hours';
        else readable = minutes + ' minutes';
        
        return readable;
    }
    
    // That function shows update-interval's value on a visible HTML element
    function updateIntervalValue () {
        var interval = parseInt(document.getElementById("update-interval").value);
        
        document.getElementById("update-interval-value").innerText = readableInterval(interval);
    }
    
    // when the page is loaded, get extension preferences and assign them into correct input elements
    window.addEventListener("load", function() {
        loadPrefs()
        
        if (location.hash == '' || !document.getElementById(location.hash.replace('#', ''))) location.hash = 'preferences'
        else document.getElementById(location.hash.replace('#', '')).className = 'active';
        
        var sections = document.querySelectorAll("section"),
              nav = document.getElementById('nav'),
              currentSection = document.getElementById(location.hash.replace('#', ''));
              
        currentSection.className = 'active';
        
        for (i = 0; i < sections.length; i++) {
            var thisID = sections[i].id;
            activeClass = ('#' + thisID == location.hash ? ' class="active"' : '');
            
            nav.innerHTML += '<a href="#' +thisID + '" id="' +thisID + '-tab"' +activeClass+ '>' +thisID+ '</a>';
        }
    }, false);
    
    // when update interval is changed, update the value in the isible area
    document.getElementById("update-interval").addEventListener("change", updateIntervalValue, false);
    
    document.getElementById('update').addEventListener('click', function() { 
        var loading = document.createElement('img'),
              update_button = document.getElementById('update');
        
        loading.src = 'images/loading.png';
        loading.id = 'loading_spinner';
        
        if (!document.getElementById('loading_spinner')) update_button.parentNode.insertBefore(loading, update_button.nextSibling);        
        
        var updated = update(function(u) {
            if (document.getElementById('loading_spinner')) loading.parentNode.removeChild(loading);

            if (u == 2) $.modal('The CSS patches file was successfully updated!', { overlayClose: true });
            else if (u == 1) $.modal('No changes have been made to the CSS patches file since you last updated it.', { overlayClose: true });
            else $.modal('There was an error updating the CSS patches file' + (u != 0 ? ': \n\n' + u : '.'), { overlayClose: true });            
        });
    }, false)
    
    function freezeClick(e) {
        e.preventDefault()
    }
    
    window.addEventListener('hashchange', function() {
        var lastTab = document.querySelector('a.active'),
              lastSection = document.querySelector('section.active'),
              currentHash = location.hash.replace('#', '') || '',
              currentTab = document.getElementById(currentHash + '-tab'),
              currentSection = document.getElementById(currentHash);
              
        if (currentHash == '' || !currentSection) { // don't allow the URL to change to an empty hash
            location.hash = 'preferences';
            return;
        }
        
        lastTab.className = '';
        lastSection.className = 'inactive';
        currentTab.className = 'active';
        
        // cancel any click events temporarily to fix the problem of tabs not working after you click a non-active tab during animation
        window.addEventListener('click', freezeClick, false);
        
        setTimeout(function() {
            lastSection.className = '';
            currentSection.className = 'active';
            
            // remove the "click freeze"
            window.removeEventListener('click', freezeClick, false);
        }, 600)
    }, false);
    
    // OAuth authentication
    
    if ( isLoggedIn() ) {
        $('#connected').removeClass('hide');
        $('#loading').attr('class', 'hide');
    } else {
        $('#auth').removeClass('hide');
        $('#loading').attr('class', 'hide');
    }
    
    // disconnect from your Twitter account
    $('#disconnect').click(function(e) {
        e.preventDefault ();
        
        $('#connected').fadeOut(500, function() {
            widget.preferences.access_token = ''; // remove the access token from local storage
            
            $('#auth').removeClass('hide');   
            $('#auth').css('opacity', 0).animate({
                opacity: 1
            }, 650);
        });
    });
    
    $('#auth').bind('submit', function() {
        $.modal ('Click the "<strong>Sign in with Twitter</strong>" button before entering a PIN number.', { overlayClose: true });
        
        return false;
    });
    
    $('#twitter-login').click(function() { // Twitter OAuth
        oauth = new OAuth(CONFIG.twitter);
        oauth.fetchRequestToken(function(url) {
            window.open(url, 'authorise', 'width=700,height=400,resizable=no');
        }, failureHandler);
        
        $.modal ('A window should appear asking you to authorize this app on Twitter. After authorizing "Fix the Web", copy the PIN number Twitter gives you and paste it into the text box below the sign in button.', {maxWidth: Math.abs(window.innerWidth - 150), overlayClose: true})
        
        $('#auth').unbind('submit'); // detach the previously attached event handler
        
        $('#auth').bind('submit', function() { // add new event handler
            var pin = $('#pin-number', this).val();

            if (!pin || !pin.length) $.modal('Please enter the PIN number you got from Twitter.', { overlayClose: true })
            else {
                $('#auth').fadeTo(500, 0.4);
                
                oauth.setVerifier (pin);
                
                oauth.fetchAccessToken(function(data) {
                    var query_string = parseQueryString(data.text),
                          oauth_access_token = query_string.oauth_token || '',
                          oauth_access_secret = query_string.oauth_token_secret || '';
                          
                    widget.preferences.access_token = oauth_access_token + '|' + oauth_access_secret;
                    
                    // hide authorization form and show the "logged in" paragraph
                    $('#auth').addClass('hide');
                    $('#connected').removeClass('hide');
                    
                    $.modal('You are signed in!', { overlayClose: true });
                }, failureHandler);
            }

            return false;
        });
        
        return false;
    });
    
    function failureHandler (data) { data ? console.log(data) : console.log('Request failed') }
    
    // parses a query string and returns 
    function parseQueryString (a,b,c,d,e) {for(b=/[?&]?([^=]+)=([^&]*)/g,c={},e=decodeURIComponent;d=b.exec(a.replace(/\+/g,' '));c[e(d[1])]=e(d[2]));return c;}
    </script>
</body>
</html>